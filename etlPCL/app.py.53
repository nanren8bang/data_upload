
import importlib
import os
import time
import configparser
import concurrent.futures
import subprocess


def execute_command(command, exit_script = 1):

    print('Will excute  commad '+command+"\n")

    p = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    response, error = p.communicate()
    if error:
        print("FAILED to run command: %s - Reason: %s"%(command,error))
        os.killpg(os.getpgrp(),2)
    return response, error


def main():
    myDir     = os.path.dirname(os.path.realpath(__file__)) #<--get current directory where this Python script located
    print('The location for this Report creater script= '+myDir)

    #dataFileName='ODP_database_master_20220429.txt'
    dataFileName='Linked_report_database_20220429.txt'
    dataFileFullPath  = '%s/%s/%s' % (os.path.abspath('.'),'etlData',dataFileName) ##<--dataset in curret path's sub folder 'data'
    print('\n---Start to process file %s---\n\n'%(dataFileFullPath))

    #0: get credential for dispatch and shards, please put your DB credentail into your home directory file "~/.my.cnf" 
    
    configParser = configparser.RawConfigParser()
    configParser.read('%s/.my.cnf' % os.path.expanduser('~'))
    myUser=''
    myPassword=''
    try:
       myUser = configParser.get('oracle', 'user')
       myPassword = configParser.get('oracle', 'password')
    except (configparser.NoSectionError, configparser.NoOptionError) as e:
        print('FAILED: Reading ini file for username/password - Reason: %s' % e)
    
    print('Got your user name %s and passwd'%(myUser))

    start_time=time.time()

    ##Taks1: open file and read line by line

    #dataFileName='ODP_database_master_20220429.txt'

    #print('Before File convertion\n')
    #execute_command("vim + "+"\"set nobomb | set fenc=utf8 | x\""+" "+dataFileFullPath ) #<---convert file encoding to UTF-8
    #print('After file conversion\n') 
    #dataFileFullPath  = '%s/%s/%s' % (os.path.abspath('.'),'etlData',dataFileName) ##<--dataset in curret path's sub folder 'data'
    print('\n---Start to process file %s---\n\n'%(dataFileFullPath))

    file = open(dataFileFullPath, 'r')
    count=0
    listOfTuple=[]
    Lines = file.readlines()
    for line in Lines:
        count += 1
        print(line)

    print('Totall lines in file='+str(count))

    print('\n---End ETL---\n')
  
    print("Time used :", time.time() - start_time)
 
